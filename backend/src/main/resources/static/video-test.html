<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ë¹„ë””ì˜¤ í…ŒìŠ¤íŠ¸ í˜ì´ì§€</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        video { width: 640px; height: 480px; border: 1px solid #ccc; margin: 10px 0; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .test-btn { background-color: #007bff; color: white; }
        .delete-btn { background-color: #dc3545; color: white; }
        .refresh-btn { background-color: #28a745; color: white; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ¥ ë¹„ë””ì˜¤ ì¬ìƒ í…ŒìŠ¤íŠ¸</h1>

    <div class="test-section">
        <h2>1. ë…¹í™” ëª©ë¡ ë° ê´€ë¦¬</h2>
        <button class="refresh-btn" onclick="loadRecordings()">ğŸ“‹ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        <button class="delete-btn" onclick="deleteAllRecordings()">ğŸ—‘ï¸ ëª¨ë“  ì˜ìƒ ì‚­ì œ</button>
        <div id="recordings-list">
            <p>ë…¹í™” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    <div class="test-section">
        <h2>2. ë¹„ë””ì˜¤ ì¬ìƒ í…ŒìŠ¤íŠ¸</h2>
        <div id="video-container">
            <p>ìœ„ ëª©ë¡ì—ì„œ ë¹„ë””ì˜¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
        </div>
    </div>

    <div class="test-section">
        <h2>3. ë””ë²„ê·¸ ì •ë³´</h2>
        <pre id="debug-info">ë””ë²„ê·¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</pre>
    </div>

    <script>
        function log(message) {
            console.log(message);
            const debugInfo = document.getElementById('debug-info');
            debugInfo.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
        }

        async function loadRecordings() {
            try {
                log('ğŸ“‹ ë…¹í™” ëª©ë¡ ë¡œë“œ ì‹œì‘...');
                const response = await fetch('/api/openvidu/recordings');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const recordings = await response.json();
                log(`âœ… ${recordings.length}ê°œì˜ ë…¹í™” íŒŒì¼ ë°œê²¬`);

                const listContainer = document.getElementById('recordings-list');
                if (recordings.length === 0) {
                    listContainer.innerHTML = '<p>ë…¹í™”ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                let html = '<h3>ë…¹í™” íŒŒì¼ ëª©ë¡:</h3>';
                recordings.forEach((recording, index) => {
                    const fileName = recording.key.split('/').pop();
                    const fileSize = Math.round(recording.size / 1024) + ' KB';

                    html += `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                            <strong>${fileName}</strong> (${fileSize})
                            <br>
                            <small>URL: ${recording.url}</small>
                            <br>
                            <button class="test-btn" onclick="testVideo('${recording.url}', '${fileName}')">
                                ğŸ¬ ì¬ìƒ í…ŒìŠ¤íŠ¸
                            </button>
                            <button class="test-btn" onclick="testVideoWithProxy('${recording.url}', '${fileName}')">
                                ğŸ”„ í”„ë¡ì‹œë¡œ ì¬ìƒ
                            </button>
                        </div>
                    `;
                });

                listContainer.innerHTML = html;
            } catch (error) {
                log(`âŒ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        async function testVideo(videoUrl, fileName) {
            try {
                log(`ğŸ¬ ì§ì ‘ ì¬ìƒ í…ŒìŠ¤íŠ¸: ${fileName}`);
                log(`ğŸ“ URL: ${videoUrl}`);

                const videoContainer = document.getElementById('video-container');
                videoContainer.innerHTML = `
                    <h3>ì§ì ‘ ì¬ìƒ: ${fileName}</h3>
                    <video controls preload="auto" crossorigin="anonymous">
                        <source src="${videoUrl}" type="video/mp4">
                        <source src="${videoUrl}" type="video/webm">
                        ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </video>
                    <br>
                    <small>ì§ì ‘ S3 URL ì‚¬ìš©</small>
                `;

                const video = videoContainer.querySelector('video');

                video.addEventListener('loadstart', () => log('ğŸ“¥ ë¹„ë””ì˜¤ ë¡œë”© ì‹œì‘'));
                video.addEventListener('loadedmetadata', () => log('ğŸ“Š ë©”íƒ€ë°ì´í„° ë¡œë“œ ì™„ë£Œ'));
                video.addEventListener('loadeddata', () => log('ğŸ“¦ ë°ì´í„° ë¡œë“œ ì™„ë£Œ'));
                video.addEventListener('canplay', () => log('â–¶ï¸ ì¬ìƒ ê°€ëŠ¥'));
                video.addEventListener('error', (e) => {
                    log(`âŒ ë¹„ë””ì˜¤ ì˜¤ë¥˜: ${e.target.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                    log(`ğŸ” ì˜¤ë¥˜ ì½”ë“œ: ${e.target.error?.code}`);
                });

            } catch (error) {
                log(`âŒ ì¬ìƒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        async function testVideoWithProxy(videoUrl, fileName) {
            try {
                log(`ğŸ”„ í”„ë¡ì‹œ ì¬ìƒ í…ŒìŠ¤íŠ¸: ${fileName}`);

                const proxyUrl = `/api/openvidu/recordings/video?url=${encodeURIComponent(videoUrl)}`;
                log(`ğŸ“ í”„ë¡ì‹œ URL: ${proxyUrl}`);

                const videoContainer = document.getElementById('video-container');
                videoContainer.innerHTML = `
                    <h3>í”„ë¡ì‹œ ì¬ìƒ: ${fileName}</h3>
                    <video controls preload="auto" crossorigin="anonymous">
                        <source src="${proxyUrl}" type="video/mp4">
                        ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </video>
                    <br>
                    <small>ë°±ì—”ë“œ í”„ë¡ì‹œ ì‚¬ìš©</small>
                `;

                const video = videoContainer.querySelector('video');

                video.addEventListener('loadstart', () => log('ğŸ“¥ í”„ë¡ì‹œ ë¹„ë””ì˜¤ ë¡œë”© ì‹œì‘'));
                video.addEventListener('loadedmetadata', () => log('ğŸ“Š í”„ë¡ì‹œ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì™„ë£Œ'));
                video.addEventListener('loadeddata', () => log('ğŸ“¦ í”„ë¡ì‹œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ'));
                video.addEventListener('canplay', () => log('â–¶ï¸ í”„ë¡ì‹œ ì¬ìƒ ê°€ëŠ¥'));
                video.addEventListener('error', (e) => {
                    log(`âŒ í”„ë¡ì‹œ ë¹„ë””ì˜¤ ì˜¤ë¥˜: ${e.target.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                    log(`ğŸ” í”„ë¡ì‹œ ì˜¤ë¥˜ ì½”ë“œ: ${e.target.error?.code}`);
                });

            } catch (error) {
                log(`âŒ í”„ë¡ì‹œ ì¬ìƒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        async function deleteAllRecordings() {
            if (!confirm('ì •ë§ë¡œ ëª¨ë“  ë…¹í™” ì˜ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) {
                return;
            }

            try {
                log('ğŸ—‘ï¸ ëª¨ë“  ì˜ìƒ ì‚­ì œ ìš”ì²­...');
                const response = await fetch('/api/openvidu/recordings/clear-all', {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const message = await response.text();
                    log(`âœ… ì‚­ì œ ì„±ê³µ: ${message}`);
                    loadRecordings(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    const errorMessage = await response.text();
                    log(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${errorMessage}`);
                }
            } catch (error) {
                log(`âŒ ì‚­ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ëª©ë¡ ë¡œë“œ
        window.addEventListener('load', () => {
            log('ğŸš€ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ë…¹í™” ëª©ë¡ ë¡œë“œ ì‹œì‘');
            loadRecordings();
        });
    </script>
</body>
</html>