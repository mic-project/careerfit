<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>OpenVidu 1:1 Call Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #videos { display: flex; gap: 20px; margin-top: 20px; }
        video { width: 480px; height: 360px; border-radius: 8px; background-color: #f0f0f0; }
        #join-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap;}
        button { padding: 10px 15px; border-radius: 5px; border: none; cursor: pointer; background-color: #007bff; color: white; }
        button:disabled { background-color: #ccc; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 5px; }

        /* ë…¹í™” ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        #recordings-section { margin-top: 40px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; }
        #recordings-list { margin-top: 15px; }
        .recording-item { display: flex; align-items: center; gap: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px; background-color: white; }
        .recording-info { flex: 1; }
        .recording-title { font-weight: bold; }
        .recording-meta { font-size: 12px; color: #666; }
        .play-btn { background-color: #28a745; padding: 5px 10px; }
        #video-player { margin-top: 20px; }
        #video-player video { width: 100%; max-width: 640px; height: auto; }
    </style>
</head>
<body>
<h1>1:1 í™”ìƒí†µí™” í…ŒìŠ¤íŠ¸</h1>
    <!-- 1:1 í™”ìƒ í†µí™”ì— ì‚¬ìš©ë˜ëŠ” ê¸°ì¡´ UIê°€ ìˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤. -->
    <div id="join-form">
        <input type="text" id="session-name" placeholder="ë©´ì ‘ë°© ì´ë¦„">
        <input type="text" id="user-name" placeholder="ë‚´ ì´ë¦„">
        <button id="join-session-btn">1:1 ë©´ì ‘ ì°¸ì—¬</button>

        <!-- ì•„ë˜ ë²„íŠ¼ì„ ìƒˆë¡œ ì¶”ê°€í•©ë‹ˆë‹¤. -->
        <button id="solo-practice-btn">í˜¼ì ë©´ì ‘ ì—°ìŠµí•˜ê¸°</button>
    </div>

<div id="join-controls">
    <button id="join-btn">1. ìƒˆ í†µí™” ì‹œì‘í•˜ê¸°</button>
    <span>ë˜ëŠ”</span>
    <div>
        <input type="text" id="session-id-input" placeholder="ë°›ì€ ì„¸ì…˜ IDë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°" size="30"/>
        <button id="join-existing-btn">2. ê¸°ì¡´ í†µí™” ì°¸ì—¬í•˜ê¸°</button>
    </div>
    <button id="leave-btn" disabled style="background-color: #dc3545;">í†µí™” ì¢…ë£Œ</button>
</div>

<div id="videos">
    <div>
        <h2>ë‚´ í™”ë©´</h2>
        <div id="publisher"></div>
    </div>
    <div>
        <h2>ìƒëŒ€ë°© í™”ë©´</h2>
        <div id="subscriber"></div>
    </div>
</div>

<!-- ë…¹í™” ëª©ë¡ ë° í”Œë ˆì´ì–´ ì„¹ì…˜ -->
<div id="recordings-section">
    <h2>ğŸ“¹ ë…¹í™”ëœ ì˜ìƒ ëª©ë¡</h2>
    <button id="refresh-recordings-btn" style="background-color: #17a2b8;">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>

    <div id="recordings-list">
        <p>ë…¹í™” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <div id="video-player" style="display: none;">
        <h3>ğŸ¬ ì˜ìƒ ì¬ìƒ</h3>
        <video controls id="playback-video">
            ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ ì¬ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </video>
        <div style="margin-top: 10px;">
            <button id="close-player-btn" style="background-color: #6c757d;">í”Œë ˆì´ì–´ ë‹«ê¸°</button>
        </div>
    </div>
</div>

<!-- âœ… CDN ë§í¬ ëŒ€ì‹ , í”„ë¡œì íŠ¸ ë‚´ë¶€ì— ì¶”ê°€í•œ ë¡œì»¬ íŒŒì¼ì„ ì§ì ‘ ì°¸ì¡°í•˜ë„ë¡ ìˆ˜ì •í•©ë‹ˆë‹¤. -->
<script src="openvidu-browser.min.js"></script>
<script src="app.js?v=20250929001"></script>

<!-- ğŸ”§ ê°•ì œ JavaScript ì´ˆê¸°í™” -->
<script>
console.log("ğŸ”§ HTMLì—ì„œ ì§ì ‘ ì‹¤í–‰ë˜ëŠ” JavaScript!");

// í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì¦‰ì‹œ ì‹¤í–‰
window.addEventListener('load', function() {
    console.log("ğŸ”§ Window load ì´ë²¤íŠ¸ ë°œìƒ!");

    // ë…¹í™” ëª©ë¡ ì„¹ì…˜ í‘œì‹œ ì—¬ë¶€ í™•ì¸
    const recordingsSection = document.getElementById('recordings-section');
    if (recordingsSection) {
        console.log("âœ… recordings-section ì—˜ë¦¬ë¨¼íŠ¸ ì°¾ìŒ!");
        recordingsSection.style.display = 'block';
    } else {
        console.log("âŒ recordings-section ì—˜ë¦¬ë¨¼íŠ¸ ì—†ìŒ!");
    }

    // ë²„íŠ¼ ìƒíƒœ ê°•ì œ ì´ˆê¸°í™”
    const soloPracticeBtn = document.getElementById('solo-practice-btn');
    if (soloPracticeBtn) {
        console.log("âœ… solo-practice-btn ì—˜ë¦¬ë¨¼íŠ¸ ì°¾ìŒ!");
        soloPracticeBtn.dataset.state = 'ready';
        soloPracticeBtn.textContent = 'ğŸ¥ í˜¼ì ë©´ì ‘ ì—°ìŠµí•˜ê¸°';

        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€
        soloPracticeBtn.onclick = null;
        soloPracticeBtn.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();

            console.log("ğŸ”§ HTML ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì‹¤í–‰ë¨!");

            const state = this.dataset.state || 'ready';
            console.log("í˜„ì¬ ìƒíƒœ:", state);

            if (state === 'ready') {
                console.log("ì—°ìŠµ ì‹œì‘ ì‹œë„...");
                this.dataset.state = 'processing';
                this.textContent = 'â³ ì‹œì‘ ì¤‘...';

                if (typeof startSoloPractice === 'function') {
                    startSoloPractice();
                } else {
                    console.log("startSoloPractice í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!");
                }
            } else if (state === 'practicing') {
                console.log("ì—°ìŠµ ì¢…ë£Œ ì‹œë„...");
                this.dataset.state = 'processing';
                this.textContent = 'â³ ì¢…ë£Œ ì¤‘...';

                if (typeof endSoloPractice === 'function') {
                    endSoloPractice();
                } else {
                    console.log("endSoloPractice í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!");
                }

                // 5ì´ˆ í›„ ê°•ì œë¡œ ë²„íŠ¼ ìƒíƒœ ë¦¬ì…‹
                setTimeout(() => {
                    console.log("ğŸ”„ ë²„íŠ¼ ìƒíƒœ ê°•ì œ ë¦¬ì…‹");
                    this.dataset.state = 'ready';
                    this.textContent = 'ğŸ¥ í˜¼ì ë©´ì ‘ ì—°ìŠµí•˜ê¸°';
                }, 5000);

            } else if (state === 'processing') {
                console.log("ğŸ”„ ì²˜ë¦¬ ì¤‘ ìƒíƒœ - ê°•ì œ ë¦¬ì…‹ ì‹œë„");
                this.dataset.state = 'ready';
                this.textContent = 'ğŸ¥ í˜¼ì ë©´ì ‘ ì—°ìŠµí•˜ê¸°';
            } else {
                console.log("âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ:", state);
            }
        });
    } else {
        console.log("âŒ solo-practice-btn ì—˜ë¦¬ë¨¼íŠ¸ ì—†ìŒ!");
    }

    // ë…¹í™” ëª©ë¡ ë¡œë“œ ì‹œë„
    setTimeout(function() {
        console.log("ğŸ”§ ê°•ì œ ë…¹í™” ëª©ë¡ ë¡œë“œ ì‹œë„...");
        if (typeof loadRecordingsList === 'function') {
            loadRecordingsList();
        } else {
            console.log("loadRecordingsList í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!");

            // ìˆ˜ë™ìœ¼ë¡œ API í˜¸ì¶œ ë° ëª©ë¡ í‘œì‹œ
            fetch('/api/openvidu/recordings')
                .then(response => {
                    console.log("API ì‘ë‹µ:", response.status);
                    return response.json();
                })
                .then(data => {
                    console.log("ë…¹í™” ëª©ë¡:", data);
                    const recordingsList = document.getElementById('recordings-list');
                    if (recordingsList && data.length > 0) {
                        let html = '';
                        data.forEach((recording, index) => {
                            const fileName = recording.key.split('/').pop();
                            const fileSize = (recording.size / 1024 / 1024).toFixed(2);
                            const lastModified = new Date(recording.lastModified).toLocaleString('ko-KR');

                            html += `
                                <div class="recording-item">
                                    <div class="recording-info">
                                        <div class="recording-title">ğŸ“¹ ${fileName}</div>
                                        <div class="recording-meta">
                                            í¬ê¸°: ${fileSize} MB | ìƒì„±ì¼: ${lastModified}
                                        </div>
                                    </div>
                                    <button class="play-btn" onclick="console.log('ğŸ¬ ì¬ìƒ ë²„íŠ¼ í´ë¦­ë¨:', '${fileName}'); forcePlayVideo('${recording.url}', '${fileName}')">
                                        â–¶ï¸ ì¬ìƒ
                                    </button>
                                </div>
                            `;
                        });
                        recordingsList.innerHTML = html;
                    } else if (recordingsList) {
                        recordingsList.innerHTML = '<p>âœ… ë…¹í™” ëª©ë¡ ë¡œë“œ ì„±ê³µ: ' + data.length + 'ê°œ íŒŒì¼</p>';
                    }
                })
                .catch(error => {
                    console.error("ë…¹í™” ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", error);
                });

    // ê°•ì œ ì˜ìƒ ì¬ìƒ í•¨ìˆ˜ ì¶”ê°€
    window.forcePlayVideo = function(videoUrl, fileName) {
        try {
            console.log("ğŸ¬ ê°•ì œ ì˜ìƒ ì¬ìƒ ì‹œì‘:", fileName);
            console.log("ğŸ“ ë¹„ë””ì˜¤ URL:", videoUrl);

            // URL ìœ íš¨ì„± ê²€ì‚¬
            if (!videoUrl || videoUrl.trim() === '') {
                console.error("âŒ ë¹„ë””ì˜¤ URLì´ ë¹„ì–´ìˆìŒ");
                alert("ë¹„ë””ì˜¤ URLì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }

            // ë¨¼ì € URL ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
            console.log("ğŸ” URL ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ì‹œì‘...");
            fetch(videoUrl, { method: 'HEAD' })
                .then(response => {
                    console.log("ğŸ“¡ URL ì ‘ê·¼ì„± ê²°ê³¼:", response.status, response.statusText);
                    console.log("ğŸ”— Response headers:", Array.from(response.headers.entries()));

                    if (!response.ok) {
                        console.error("âŒ URL ì ‘ê·¼ ë¶ˆê°€:", response.status);
                        alert(`ë¹„ë””ì˜¤ URLì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (${response.status})`);
                        return;
                    }

                    // URLì´ ì •ìƒì ì´ë©´ ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ ì„¤ì •
                    setupVideoPlayer();
                })
                .catch(error => {
                    console.error("âŒ URL ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:", error);
                    console.log("âš ï¸ CORS ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ê°€ëŠ¥, ì§ì ‘ ë¹„ë””ì˜¤ ë¡œë“œ ì‹œë„");

                    // CORS ë¬¸ì œì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì§ì ‘ ë¹„ë””ì˜¤ ë¡œë“œ ì‹œë„
                    setupVideoPlayer();
                });

            function setupVideoPlayer() {
                const videoPlayer = document.getElementById('video-player');
                const playbackVideo = document.getElementById('playback-video');

                if (!videoPlayer) {
                    console.error("âŒ video-player ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ");
                    return;
                }

                if (!playbackVideo) {
                    console.error("âŒ playback-video ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ");
                    return;
                }

                // ì´ì „ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
                playbackVideo.removeEventListener('loadstart', handleLoadStart);
                playbackVideo.removeEventListener('canplay', handleCanPlay);
                playbackVideo.removeEventListener('error', handleError);
                playbackVideo.removeEventListener('loadedmetadata', handleLoadedMetadata);

                // ì´ì „ ë¹„ë””ì˜¤ ì •ë¦¬
                playbackVideo.pause();
                playbackVideo.removeAttribute('src');
                playbackVideo.load();

                console.log("ğŸ”„ ì´ì „ ë¹„ë””ì˜¤ ì •ë¦¬ ì™„ë£Œ");

                // í”Œë ˆì´ì–´ í‘œì‹œ
                videoPlayer.style.display = 'block';

                // ìƒˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                playbackVideo.addEventListener('loadstart', handleLoadStart);
                playbackVideo.addEventListener('canplay', handleCanPlay);
                playbackVideo.addEventListener('error', handleError);
                playbackVideo.addEventListener('loadedmetadata', handleLoadedMetadata);

                // progress ì´ë²¤íŠ¸ë¡œ ë¡œë”© ìƒíƒœ í™•ì¸
                playbackVideo.addEventListener('progress', function() {
                    console.log("ğŸ“Š ë¹„ë””ì˜¤ ë¡œë”© ì§„í–‰ë¥ :", playbackVideo.buffered.length);
                });

                // ë¹„ë””ì˜¤ URL ì„¤ì • ë° ë¡œë“œ
                console.log("ğŸ”— ë¹„ë””ì˜¤ URL ì„¤ì •:", videoUrl);
                playbackVideo.src = videoUrl;
                playbackVideo.crossOrigin = "anonymous"; // CORS ì‹œë„
                playbackVideo.load();

                console.log("âœ… ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ ì„¤ì • ì™„ë£Œ");

                // í”Œë ˆì´ì–´ ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤
                videoPlayer.scrollIntoView({ behavior: 'smooth' });

                // 2ì´ˆ í›„ ìƒíƒœ í™•ì¸
                setTimeout(() => {
                    console.log("ğŸ” 2ì´ˆ í›„ ë¹„ë””ì˜¤ ìƒíƒœ:");
                    console.log("- readyState:", playbackVideo.readyState);
                    console.log("- networkState:", playbackVideo.networkState);
                    console.log("- currentSrc:", playbackVideo.currentSrc);
                    console.log("- videoWidth:", playbackVideo.videoWidth);
                    console.log("- videoHeight:", playbackVideo.videoHeight);
                    console.log("- duration:", playbackVideo.duration);

                    // ìë™ ì¬ìƒ ì‹œë„
                    playbackVideo.play().then(() => {
                        console.log("â–¶ï¸ ìë™ ì¬ìƒ ì„±ê³µ");
                    }).catch(error => {
                        console.log("âš ï¸ ìë™ ì¬ìƒ ì‹¤íŒ¨ (ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í•„ìš”):", error.message);
                        console.log("ğŸ‘† ì‚¬ìš©ìê°€ ì§ì ‘ ì¬ìƒ ë²„íŠ¼ì„ í´ë¦­í•´ì•¼ í•©ë‹ˆë‹¤");
                    });
                }, 2000);
            }

            function handleLoadStart() {
                console.log("ğŸ“¥ ë¹„ë””ì˜¤ ë¡œë”© ì‹œì‘");
            }

            function handleCanPlay() {
                console.log("â–¶ï¸ ë¹„ë””ì˜¤ ì¬ìƒ ì¤€ë¹„ ì™„ë£Œ");
            }

            function handleError(e) {
                console.error("âŒ ë¹„ë””ì˜¤ ë¡œë“œ ì˜¤ë¥˜:", e);
                console.error("ì˜¤ë¥˜ ì„¸ë¶€ì‚¬í•­:", playbackVideo.error);
                if (playbackVideo.error) {
                    console.error("- ì˜¤ë¥˜ ì½”ë“œ:", playbackVideo.error.code);
                    console.error("- ì˜¤ë¥˜ ë©”ì‹œì§€:", playbackVideo.error.message);
                }
                alert("ë¹„ë””ì˜¤ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì—ì„œ ì„¸ë¶€ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”.");
            }

            function handleLoadedMetadata() {
                console.log("ğŸ“‹ ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì™„ë£Œ");
                console.log("- í•´ìƒë„:", playbackVideo.videoWidth + "x" + playbackVideo.videoHeight);
                console.log("- ì¬ìƒ ì‹œê°„:", playbackVideo.duration + "ì´ˆ");
            }

        } catch (error) {
            console.error("âŒ ì˜ìƒ ì¬ìƒ ì˜¤ë¥˜:", error);
            alert("ì˜ìƒ ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        }
    };
        }
    }, 1000);
});
</script>
</body>
</html>