<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>OpenVidu 1:1 Call Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #videos { display: flex; gap: 20px; margin-top: 20px; }
        video { width: 480px; height: 360px; border-radius: 8px; background-color: #f0f0f0; }
        #join-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap;}
        button { padding: 10px 15px; border-radius: 5px; border: none; cursor: pointer; background-color: #007bff; color: white; }
        button:disabled { background-color: #ccc; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 5px; }

        /* 녹화 관련 스타일 */
        #recordings-section { margin-top: 40px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; }
        #recordings-list { margin-top: 15px; }
        .recording-item { display: flex; align-items: center; gap: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px; background-color: white; }
        .recording-info { flex: 1; }
        .recording-title { font-weight: bold; }
        .recording-meta { font-size: 12px; color: #666; }
        .play-btn { background-color: #28a745; padding: 5px 10px; }
        #video-player { margin-top: 20px; }
        #video-player video { width: 100%; max-width: 640px; height: auto; }
    </style>
</head>
<body>
<h1>1:1 화상통화 테스트</h1>
    <!-- 1:1 화상 통화에 사용되는 기존 UI가 있다고 가정합니다. -->
    <div id="join-form">
        <input type="text" id="session-name" placeholder="면접방 이름">
        <input type="text" id="user-name" placeholder="내 이름">
        <button id="join-session-btn">1:1 면접 참여</button>

        <!-- 아래 버튼을 새로 추가합니다. -->
        <button id="solo-practice-btn">혼자 면접 연습하기</button>
    </div>

<div id="join-controls">
    <button id="join-btn">1. 새 통화 시작하기</button>
    <span>또는</span>
    <div>
        <input type="text" id="session-id-input" placeholder="받은 세션 ID를 여기에 붙여넣기" size="30"/>
        <button id="join-existing-btn">2. 기존 통화 참여하기</button>
    </div>
    <button id="leave-btn" disabled style="background-color: #dc3545;">통화 종료</button>
</div>

<div id="videos">
    <div>
        <h2>내 화면</h2>
        <div id="publisher"></div>
    </div>
    <div>
        <h2>상대방 화면</h2>
        <div id="subscriber"></div>
    </div>
</div>

<!-- 녹화 목록 및 플레이어 섹션 -->
<div id="recordings-section">
    <h2>📹 녹화된 영상 목록</h2>
    <button id="refresh-recordings-btn" style="background-color: #17a2b8;">목록 새로고침</button>

    <div id="recordings-list">
        <p>녹화 목록을 불러오는 중...</p>
    </div>

    <div id="video-player" style="display: none;">
        <h3>🎬 영상 재생</h3>
        <video controls id="playback-video">
            브라우저가 비디오 재생을 지원하지 않습니다.
        </video>
        <div style="margin-top: 10px;">
            <button id="close-player-btn" style="background-color: #6c757d;">플레이어 닫기</button>
        </div>
    </div>
</div>

<!-- ✅ CDN 링크 대신, 프로젝트 내부에 추가한 로컬 파일을 직접 참조하도록 수정합니다. -->
<script src="openvidu-browser.min.js"></script>
<script src="app.js?v=20250929001"></script>

<!-- 🔧 강제 JavaScript 초기화 -->
<script>
console.log("🔧 HTML에서 직접 실행되는 JavaScript!");

// 페이지 로드 완료 시 즉시 실행
window.addEventListener('load', function() {
    console.log("🔧 Window load 이벤트 발생!");

    // 녹화 목록 섹션 표시 여부 확인
    const recordingsSection = document.getElementById('recordings-section');
    if (recordingsSection) {
        console.log("✅ recordings-section 엘리먼트 찾음!");
        recordingsSection.style.display = 'block';
    } else {
        console.log("❌ recordings-section 엘리먼트 없음!");
    }

    // 버튼 상태 강제 초기화
    const soloPracticeBtn = document.getElementById('solo-practice-btn');
    if (soloPracticeBtn) {
        console.log("✅ solo-practice-btn 엘리먼트 찾음!");
        soloPracticeBtn.dataset.state = 'ready';
        soloPracticeBtn.textContent = '🎥 혼자 면접 연습하기';

        // 기존 이벤트 리스너 제거 후 새로 추가
        soloPracticeBtn.onclick = null;
        soloPracticeBtn.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();

            console.log("🔧 HTML 이벤트 핸들러 실행됨!");

            const state = this.dataset.state || 'ready';
            console.log("현재 상태:", state);

            if (state === 'ready') {
                console.log("연습 시작 시도...");
                this.dataset.state = 'processing';
                this.textContent = '⏳ 시작 중...';

                if (typeof startSoloPractice === 'function') {
                    startSoloPractice();
                } else {
                    console.log("startSoloPractice 함수를 찾을 수 없음!");
                }
            } else if (state === 'practicing') {
                console.log("연습 종료 시도...");
                this.dataset.state = 'processing';
                this.textContent = '⏳ 종료 중...';

                if (typeof endSoloPractice === 'function') {
                    endSoloPractice();
                } else {
                    console.log("endSoloPractice 함수를 찾을 수 없음!");
                }

                // 5초 후 강제로 버튼 상태 리셋
                setTimeout(() => {
                    console.log("🔄 버튼 상태 강제 리셋");
                    this.dataset.state = 'ready';
                    this.textContent = '🎥 혼자 면접 연습하기';
                }, 5000);

            } else if (state === 'processing') {
                console.log("🔄 처리 중 상태 - 강제 리셋 시도");
                this.dataset.state = 'ready';
                this.textContent = '🎥 혼자 면접 연습하기';
            } else {
                console.log("⚠️ 알 수 없는 상태:", state);
            }
        });
    } else {
        console.log("❌ solo-practice-btn 엘리먼트 없음!");
    }

    // 녹화 목록 로드 시도
    setTimeout(function() {
        console.log("🔧 강제 녹화 목록 로드 시도...");
        if (typeof loadRecordingsList === 'function') {
            loadRecordingsList();
        } else {
            console.log("loadRecordingsList 함수를 찾을 수 없음!");

            // 수동으로 API 호출 및 목록 표시
            fetch('/api/openvidu/recordings')
                .then(response => {
                    console.log("API 응답:", response.status);
                    return response.json();
                })
                .then(data => {
                    console.log("녹화 목록:", data);
                    const recordingsList = document.getElementById('recordings-list');
                    if (recordingsList && data.length > 0) {
                        let html = '';
                        data.forEach((recording, index) => {
                            const fileName = recording.key.split('/').pop();
                            const fileSize = (recording.size / 1024 / 1024).toFixed(2);
                            const lastModified = new Date(recording.lastModified).toLocaleString('ko-KR');

                            html += `
                                <div class="recording-item">
                                    <div class="recording-info">
                                        <div class="recording-title">📹 ${fileName}</div>
                                        <div class="recording-meta">
                                            크기: ${fileSize} MB | 생성일: ${lastModified}
                                        </div>
                                    </div>
                                    <button class="play-btn" onclick="console.log('🎬 재생 버튼 클릭됨:', '${fileName}'); forcePlayVideo('${recording.url}', '${fileName}')">
                                        ▶️ 재생
                                    </button>
                                </div>
                            `;
                        });
                        recordingsList.innerHTML = html;
                    } else if (recordingsList) {
                        recordingsList.innerHTML = '<p>✅ 녹화 목록 로드 성공: ' + data.length + '개 파일</p>';
                    }
                })
                .catch(error => {
                    console.error("녹화 목록 로드 실패:", error);
                });

    // 강제 영상 재생 함수 추가
    window.forcePlayVideo = function(videoUrl, fileName) {
        try {
            console.log("🎬 강제 영상 재생 시작:", fileName);
            console.log("📍 비디오 URL:", videoUrl);

            // URL 유효성 검사
            if (!videoUrl || videoUrl.trim() === '') {
                console.error("❌ 비디오 URL이 비어있음");
                alert("비디오 URL이 올바르지 않습니다.");
                return;
            }

            // 먼저 URL 접근성 테스트
            console.log("🔍 URL 접근성 테스트 시작...");
            fetch(videoUrl, { method: 'HEAD' })
                .then(response => {
                    console.log("📡 URL 접근성 결과:", response.status, response.statusText);
                    console.log("🔗 Response headers:", Array.from(response.headers.entries()));

                    if (!response.ok) {
                        console.error("❌ URL 접근 불가:", response.status);
                        alert(`비디오 URL에 접근할 수 없습니다 (${response.status})`);
                        return;
                    }

                    // URL이 정상적이면 비디오 플레이어 설정
                    setupVideoPlayer();
                })
                .catch(error => {
                    console.error("❌ URL 접근성 테스트 실패:", error);
                    console.log("⚠️ CORS 또는 네트워크 문제 가능, 직접 비디오 로드 시도");

                    // CORS 문제일 수 있으니 직접 비디오 로드 시도
                    setupVideoPlayer();
                });

            function setupVideoPlayer() {
                const videoPlayer = document.getElementById('video-player');
                const playbackVideo = document.getElementById('playback-video');

                if (!videoPlayer) {
                    console.error("❌ video-player 엘리먼트를 찾을 수 없음");
                    return;
                }

                if (!playbackVideo) {
                    console.error("❌ playback-video 엘리먼트를 찾을 수 없음");
                    return;
                }

                // 이전 이벤트 리스너 제거
                playbackVideo.removeEventListener('loadstart', handleLoadStart);
                playbackVideo.removeEventListener('canplay', handleCanPlay);
                playbackVideo.removeEventListener('error', handleError);
                playbackVideo.removeEventListener('loadedmetadata', handleLoadedMetadata);

                // 이전 비디오 정리
                playbackVideo.pause();
                playbackVideo.removeAttribute('src');
                playbackVideo.load();

                console.log("🔄 이전 비디오 정리 완료");

                // 플레이어 표시
                videoPlayer.style.display = 'block';

                // 새 이벤트 리스너 추가
                playbackVideo.addEventListener('loadstart', handleLoadStart);
                playbackVideo.addEventListener('canplay', handleCanPlay);
                playbackVideo.addEventListener('error', handleError);
                playbackVideo.addEventListener('loadedmetadata', handleLoadedMetadata);

                // progress 이벤트로 로딩 상태 확인
                playbackVideo.addEventListener('progress', function() {
                    console.log("📊 비디오 로딩 진행률:", playbackVideo.buffered.length);
                });

                // 비디오 URL 설정 및 로드
                console.log("🔗 비디오 URL 설정:", videoUrl);
                playbackVideo.src = videoUrl;
                playbackVideo.crossOrigin = "anonymous"; // CORS 시도
                playbackVideo.load();

                console.log("✅ 비디오 플레이어 설정 완료");

                // 플레이어 위치로 스크롤
                videoPlayer.scrollIntoView({ behavior: 'smooth' });

                // 2초 후 상태 확인
                setTimeout(() => {
                    console.log("🔍 2초 후 비디오 상태:");
                    console.log("- readyState:", playbackVideo.readyState);
                    console.log("- networkState:", playbackVideo.networkState);
                    console.log("- currentSrc:", playbackVideo.currentSrc);
                    console.log("- videoWidth:", playbackVideo.videoWidth);
                    console.log("- videoHeight:", playbackVideo.videoHeight);
                    console.log("- duration:", playbackVideo.duration);

                    // 자동 재생 시도
                    playbackVideo.play().then(() => {
                        console.log("▶️ 자동 재생 성공");
                    }).catch(error => {
                        console.log("⚠️ 자동 재생 실패 (사용자 상호작용 필요):", error.message);
                        console.log("👆 사용자가 직접 재생 버튼을 클릭해야 합니다");
                    });
                }, 2000);
            }

            function handleLoadStart() {
                console.log("📥 비디오 로딩 시작");
            }

            function handleCanPlay() {
                console.log("▶️ 비디오 재생 준비 완료");
            }

            function handleError(e) {
                console.error("❌ 비디오 로드 오류:", e);
                console.error("오류 세부사항:", playbackVideo.error);
                if (playbackVideo.error) {
                    console.error("- 오류 코드:", playbackVideo.error.code);
                    console.error("- 오류 메시지:", playbackVideo.error.message);
                }
                alert("비디오 로드 중 오류가 발생했습니다. 콘솔에서 세부사항을 확인하세요.");
            }

            function handleLoadedMetadata() {
                console.log("📋 비디오 메타데이터 로드 완료");
                console.log("- 해상도:", playbackVideo.videoWidth + "x" + playbackVideo.videoHeight);
                console.log("- 재생 시간:", playbackVideo.duration + "초");
            }

        } catch (error) {
            console.error("❌ 영상 재생 오류:", error);
            alert("영상 재생 중 오류가 발생했습니다: " + error.message);
        }
    };
        }
    }, 1000);
});
</script>
</body>
</html>